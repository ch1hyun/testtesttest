name: 'PR Discord Notification'

on:
  pull_request:
    types: 
      - opened
      - reopend
      - closed
    
jobs:
  notification:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Discord Notification
        env:
          BODY: ${{ github.event.pull_request.body }}
          USERNAME: ${{ github.event.pull_request.user.login }}
          AVATAR_URL: ${{ github.event.pull_request.user.avatar_url }}
          TITLE: ${{ github.event.pull_request.title }}
          URL: ${{ github.event.pull_request.html_url }}
        run: |
          PROBLEM=$(
            echo $BODY |
            grep -Pio 'http[\w\:\/\.\-\?\=\&]+' |
            head -1 ||
            echo "$URL" |
            tr -d '"'
          );
          echo "PROBLEM=$PROBLEM" >> $GITHUB_ENV;
          echo "USERNAME=$USERNAME" >> $GITHUB_ENV;
          echo "AVATAR_URL=$AVATAR_URL" >> $GITHUB_ENV;
          echo "TITLE=$TITLE" >> $GITHUB_ENV;
          echo "URL=$URL" >> $GITHUB_ENV;
          curl -X POST -H 'Content-type:application/json'\
          -d "{
              \"username\": \"${{ env.USERNAME }}\",
              \"avatar_url\": \"${{ env.AVATAR_URL }}\",
              \"embeds\": [
                {
                  \"title\": \"${{ env.TITLE }}\",
                  \"description\": \"😵 이 세계 벽 절대 안높아 부딪히는거야 😵\n\n${{ env.PROBLEM }}\",
                  \"url\": \"${{ env.URL }}\",
                  \"color\": \"6847432\"
                }
              ]
            }" ${{ secrets.DISCORD_WEBHOOK_URL }};
